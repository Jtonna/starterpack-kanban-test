<workflow name="PLANNING">

  <overview>
    Executed by the orchestrator when a beads ticket is picked up for work.
    Produces an approved implementation plan before any code is written.
  </overview>

  <loop>
    <!--
      INTAKE → DRAFT → REVIEW → HUMAN_GATE → HANDOFF
                 ▲        │
                 │  plan-scoped questions?
                 └────────┘
        ▲              │
        │  codebase-scoped questions?
        └──── INTAKE ──┘
                 ▲        │
                 │  rejected by human?
                 └── HUMAN_GATE
    -->

    <phase name="INTAKE" order="1">
      <actor>Orchestrator launches an Explorer agent (reasoning tier)</actor>

      <actions>
        <action>Read the beads ticket via "bd show ID"</action>
        <action>Explore the codebase to understand affected files, patterns, and dependencies</action>
        <action>Read project documentation (README.md, docs/ARCHITECTURE.md, relevant service docs)</action>
        <action>Treat code as the source of truth — flag any discrepancies where docs contradict code</action>
        <action>Identify existing utilities, functions, and conventions to reuse</action>
        <action>
          Determine if the ticket needs to be decomposed into sub-tickets first.
          If the explorer determines the scope is too large for a single planning cycle,
          report this to the orchestrator. The orchestrator should route back through
          the ENTRY workflow's SPEC_FILE path for epic decomposition.
        </action>
      </actions>

      <output>Structured context report returned to orchestrator</output>
      <status-message>executing PLANNING/INTAKE on {ticket-id} with explorer agent</status-message>
    </phase>

    <phase name="DRAFT" order="2">
      <actor>Orchestrator launches a Planner agent (reasoning tier)</actor>

      <input>The intake context report + full ticket details</input>

      <actions>
        <action>Break the ticket into small, isolated sub-tasks</action>
        <action>Each sub-task must be completable by a single implementation agent</action>
        <action>
          For each sub-task, specify:
          - What to change and which files
          - Acceptance criteria
          - Dependencies on other sub-tasks (ordering)
          - Estimated complexity (light / standard / complex)
        </action>
        <action>Identify which sub-tasks can run in parallel vs sequentially</action>
      </actions>

      <output>Structured implementation plan</output>

      <sub-task-tracking>
        <!--
          Sub-tasks are NOT separate beads tickets. They are tracked as comments on the
          parent ticket. This keeps the ticket list clean while maintaining an audit trail.
          See also: WORKFLOW_IMPLEMENTATION.xml agent-rules/sub-task-tracking for the
          swarm manager's update rules during execution.
        -->
        <rule>After the plan is approved at HUMAN_GATE, the orchestrator posts the sub-task list as a comment on the ticket</rule>
        <rule>During implementation, the swarm manager updates the comment (or adds new comments) as sub-tasks complete or fail</rule>
        <rule>Format: "[sub-task N] DONE|FAILED|IN_PROGRESS: description"</rule>
      </sub-task-tracking>

      <status-message>executing PLANNING/DRAFT on {ticket-id} with planner agent</status-message>
    </phase>

    <phase name="REVIEW" order="3">
      <actor>Orchestrator launches a Plan Reviewer agent (reasoning tier)</actor>

      <input>The implementation plan + intake context</input>

      <actions>
        <action>Review the plan for completeness, correctness, and feasibility</action>
        <action>Check for missing edge cases, circular dependencies, or overly large sub-tasks</action>
        <action>
          If the plan has issues:
          - Minor issues: modify the plan directly and note changes
          - Major issues or ambiguity: formulate clarifying questions for the human
          - Return questions to orchestrator → orchestrator asks human
        </action>
      </actions>

      <output>Approved plan (possibly modified) OR list of questions for the human</output>
      <status-message>executing PLANNING/REVIEW on {ticket-id} with plan reviewer agent</status-message>

      <on-questions>
        The orchestrator evaluates the nature of the questions:
        - Codebase-scoped questions (e.g. "how does service X handle auth?")
          → loop back to INTAKE for re-exploration with human answers as context
        - Plan-scoped questions (e.g. "should we split this into two PRs?")
          → loop back to DRAFT directly with human answers, skip INTAKE
      </on-questions>
    </phase>

    <phase name="HUMAN_GATE" order="4">
      <actor>Orchestrator presents the plan to the human</actor>

      <presents>
        <item>Summary of the ticket</item>
        <item>The sub-task breakdown with ordering</item>
        <item>Which model tier each sub-task will use</item>
        <item>Any notes from the reviewer</item>
      </presents>

      <gate>BLOCKED — Do not proceed. Human approval required before continuing.</gate>
      <on-rejection>Loop back to DRAFT with human feedback as additional context</on-rejection>
      <status-message>awaiting PLANNING/HUMAN_GATE on {ticket-id} — BLOCKED: human approval required</status-message>
    </phase>

    <phase name="HANDOFF" order="5">
      <description>
        Once approved, the plan is passed to the IMPLEMENTATION workflow.
      </description>
      <status-message>executing PLANNING/HANDOFF on {ticket-id} — transitioning to IMPLEMENTATION</status-message>
    </phase>

  </loop>

</workflow>
