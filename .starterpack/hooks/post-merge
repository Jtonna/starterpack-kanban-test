#!/bin/sh
#
# bd (beads) post-merge hook
#
# This hook imports updated issues from .beads/issues.jsonl after a
# git pull or merge, ensuring the database stays in sync with git.
# It also auto-commits any resulting .beads/ changes to prevent orphaned state.

# Check if bd is available
if ! command -v bd >/dev/null 2>&1; then
    echo "Warning: bd command not found, skipping post-merge import" >&2
    exit 0
fi

# Check if we're in a bd workspace
# For worktrees, .beads is in the main repository root, not the worktree
BEADS_DIR=""
if git rev-parse --git-dir >/dev/null 2>&1; then
    if [ "$(git rev-parse --git-dir)" != "$(git rev-parse --git-common-dir)" ]; then
        MAIN_REPO_ROOT="$(git rev-parse --git-common-dir)"
        MAIN_REPO_ROOT="$(dirname "$MAIN_REPO_ROOT")"
        if [ -d "$MAIN_REPO_ROOT/.beads" ]; then
            BEADS_DIR="$MAIN_REPO_ROOT/.beads"
        fi
    else
        if [ -d .beads ]; then
            BEADS_DIR=".beads"
        fi
    fi
fi

if [ -z "$BEADS_DIR" ]; then
    exit 0
fi

# Determine backend type
IS_DOLT=false
if [ -f "$BEADS_DIR/metadata.json" ]; then
    if grep -q '"backend"[[:space:]]*:[[:space:]]*"dolt"' "$BEADS_DIR/metadata.json" 2>/dev/null; then
        IS_DOLT=true
    fi
fi

# Import JSONL into database (SQLite backend)
if [ "$IS_DOLT" = "false" ]; then
    if [ ! -f "$BEADS_DIR/issues.jsonl" ]; then
        exit 0
    fi

    if ! bd import -i "$BEADS_DIR/issues.jsonl" >/dev/null 2>&1; then
        echo "Warning: Failed to import bd changes after merge" >&2
        echo "Run 'bd import -i $BEADS_DIR/issues.jsonl' manually to see the error" >&2
    fi
fi

# Auto-commit .beads/ changes after import to prevent orphaned state
# This ensures beads database changes from merges are tracked in git
if git diff --quiet -- "$BEADS_DIR/" 2>/dev/null; then
    # No changes to .beads/ — nothing to commit
    :
else
    # .beads/ files changed after import — auto-commit
    git add "$BEADS_DIR/" 2>/dev/null
    if ! git diff --cached --quiet -- "$BEADS_DIR/" 2>/dev/null; then
        git commit --no-verify -m "chore: sync beads after merge [skip ci]" 2>/dev/null || \
            echo "Warning: Failed to auto-commit beads changes after merge" >&2
    fi
fi

exit 0
